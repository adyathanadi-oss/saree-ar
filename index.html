<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saree Mirror AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #webcam { position: absolute; visibility: hidden; width: 1px; height: 1px; }
        #blur-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background-size: cover; background-position: center;
            filter: blur(50px) brightness(0.4); transition: background-image 0.7s ease;
        }
        canvas.a-canvas { z-index: 2; }
        #ui {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10; display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .btn {
            background: #D4AF37; color: #000; padding: 12px 25px; border: none;
            border-radius: 25px; font-weight: bold; cursor: pointer; text-decoration: none;
        }
        .shot-btn { background: #fff; color: #000; }
    </style>
</head>
<body>
    <div id="blur-bg"></div>
    <video id="webcam" autoplay playsinline></video>

    <div id="ui">
        <button class="btn shot-btn" onclick="takeSnapshot()">ðŸ“¸ SAVE PHOTO</button>
        <a id="buy-link" class="btn" href="#" target="_blank">SHOP THIS LOOK</a>
    </div>

    <a-scene vr-mode-ui="enabled: false" screenshot>
        <a-entity id="drape-container" position="0 0 -2" visible="false">
            <a-image id="saree-render" material="shader: flat; transparent: true"></a-image>
        </a-entity>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const collection = [
            { img: "saree1.png", link: "https://myshop.com/saree1" },
            { img: "saree2.png", link: "https://myshop.com/saree2" }
        ];

        let currentIdx = 0;
        let lastChange = 0;
        const sareeImg = document.querySelector('#saree-render');
        const buyLink = document.querySelector('#buy-link');
        const bg = document.querySelector('#blur-bg');
        const container = document.querySelector('#drape-container');

        function updateUI(idx) {
            sareeImg.setAttribute('src', collection[idx].img);
            bg.style.backgroundImage = `url(${collection[idx].img})`;
            buyLink.href = collection[idx].link;
        }

        function takeSnapshot() {
            const scene = document.querySelector('a-scene');
            scene.components.screenshot.capture('perspective');
            alert("Photo saved to downloads!");
        }

        updateUI(0);

        const pose = new Pose({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });

        pose.onResults((res) => {
            if (!res.poseLandmarks) { container.setAttribute('visible', 'false'); return; }
            container.setAttribute('visible', 'true');
            const m = res.poseLandmarks;
            const x3D = (0.5 - ((m[11].x + m[12].x)/2)) * 3.5;
            const y3D = (0.5 - ((m[11].y + m[12].y)/2)) * 2.5;
            container.setAttribute('position', `${x3D} ${y3D - 0.7} -2`);
            const w = Math.abs(m[11].x - m[12].x) * 4.5;
            sareeImg.setAttribute('width', w);
            sareeImg.setAttribute('height', w * 1.6);

            const now = Date.now();
            if (now - lastChange > 2000 && (m[15].y < m[11].y - 0.2 || m[16].y < m[12].y - 0.2)) {
                currentIdx = (currentIdx + 1) % collection.length;
                updateUI(currentIdx);
                lastChange = now;
            }
        });

        const v = document.getElementById('webcam');
        const cam = new Camera(v, { onFrame: async () => { await pose.send({image: v}); }, width: 1280, height: 720 });
        cam.start();
    </script>
</body>
</html>